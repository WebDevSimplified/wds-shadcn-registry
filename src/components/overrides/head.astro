---
import path from "node:path"

const { head } = Astro.locals.starlightRoute

// By default, Astro renders the default favicon before the media specific favicons which results in the media specific favicons not being used.
// This code forces the default favicon to only be used when the user has no preference for light or dark mode instead of always being used.
const sortedHead = head.map(h => {
  if (h.tag !== "link") return h
  if (
    typeof h.attrs !== "object" ||
    typeof h.attrs.rel !== "string" ||
    !h.attrs.rel.includes("icon") ||
    h.attrs.media
  ) {
    return h
  }

  return {
    ...h,
    attrs: { ...h.attrs, media: "(prefers-color-scheme: no-preference)" },
  }
})

const ogImageUrl = new URL(
  path.join(Astro.url.pathname, "og.webp"),
  Astro.url,
).toString()

const finalHead = sortedHead.concat([
  {
    tag: "meta",
    attrs: {
      property: "og:image",
      content: ogImageUrl,
    },
  },
  {
    tag: "meta",
    attrs: {
      property: "og:image:secure_url",
      content: ogImageUrl,
    },
  },
  {
    tag: "meta",
    attrs: {
      property: "og:image:width",
      content: "1200",
    },
  },
  {
    tag: "meta",
    attrs: {
      property: "og:image:height",
      content: "630",
    },
  },
  {
    tag: "meta",
    attrs: {
      name: "twitter:image",
      content: ogImageUrl,
    },
  },
])
---

{
  finalHead.map(({ tag: Tag, attrs, content }) => (
    <Tag {...attrs} set:html={content} />
  ))
}
